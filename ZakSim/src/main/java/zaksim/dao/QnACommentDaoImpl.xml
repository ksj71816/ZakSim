<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
 <mapper namespace="zaksim.dao.QnACommentDao">
 
   <resultMap type="zaksim.dto.QnAComment" id="QnAComment">
  	<result property="idx" column="idx"/>
  	<result property="qnaIdx" column="qna_idx"/>
  	<result property="upperIdx" column="upper_idx"/>
  	<result property="writerIdx" column="writer_idx"/>
  	<result property="content" column="content"/>
  	<result property="writtenDate" column="written_date"/>
  	<result property="depth" column="depth"/>
  	<result property="order" column="c_order"/>
  	<result property="upperId" column="upper_id"/>
  	<collection property="zakSimMember" resultMap="ZakSimMember"/>
  </resultMap>
  
  <resultMap type="zaksim.dto.ZakSimMember" id="ZakSimMember">
  	<result property="idx" column="z_idx"/>
  	<result property="id" column="z_id"/>
  	<result property="nick" column="z_nick"/>
  	<result property="memberType" column="member_type"/>
  	<result property="joinDate" column="join_date"/>
  	<result property="suspensionDate" column="suspension_date"/>
  	<result property="suspendNum" column="suspend_num"/>
  	<result property="leaveDate" column="leave_date"/>
  </resultMap>
  
  
 
 <select id="selectComment" parameterType="int" resultMap="QnAComment">

	select a.*, zqc.upper_id 
	from
	 	(SELECT c.*, z.id z_id
		FROM qnaComment c, zakSimMember z
		WHERE qna_idx=#{qnaIdx} AND c.writer_idx=z.idx
	) a
    left join (
    	SELECT qc.upper_idx, z.id upper_id 
    	from zaksimMember z, (
			SELECT distinct c.upper_idx, uc.writer_idx
			FROM qnaComment c, qnaComment uc 
			WHERE c.upper_idx= uc.idx
		) qc
		where z.idx=qc.writer_idx
	) zqc
	on zqc.upper_idx=a.upper_idx
	order by a.c_order asc
 </select>
 
 <insert id="qnaCommentWrite" parameterType="zaksim.dto.QnAComment">
 	INSERT INTO qnaComment
 	VALUES (qnaComment_seq.nextval, #{qnaIdx}, null, 0, #{writerIdx}, #{content}, sysdate, (
 		SELECT MAX(c_order)+1 c_order FROM qnaComment))
 </insert>
 
 <select id="selectUpperOrder" parameterType="zaksim.dto.QnAComment" resultType="int">
	SELECT NVL(MIN(c_order), 0) c_order 
	FROM qnaComment
	WHERE depth=0 
	AND c_order <![CDATA[ > ]]> (SELECT c_order FROM qnaComment where idx=#{upperIdx})
 </select>
 
 <update id="updateOrder" parameterType="int">
 	UPDATE qnaComment
 	SET c_order = c_order + 1
 	WHERE c_order <![CDATA[ > ]]>= #{order}
 </update>
 
 <insert id="qnaReCommentWrite" parameterType="zaksim.dto.QnAComment">
 	INSERT INTO qnaComment
 	VALUES (qnaComment_seq.nextval, #{qnaIdx}, #{upperIdx}, #{depth}+1, #{writerIdx}, #{content}, sysdate,
 	<if test="order != 0">
	 	#{order})
 	</if>
 	<if test="order == 0">
 		(SELECT MAX(c_order)+1 c_order FROM qnaComment WHERE qna_idx=#{qnaIdx}))
 	</if>
 </insert>
 
 <update id="updateOrderToDelete" parameterType="int">
 	UPDATE qnaComment
 	SET c_order=c_order-1
 	WHERE c_order <![CDATA[ > ]]> #{order}
 </update>
 
 <delete id="qnaCommentDelete" parameterType="int">
 	DELETE qnaComment 
 	WHERE c_order=#{order}
 </delete>
 
 <update id="qnaCommentUpdate" parameterType="zaksim.dto.QnAComment">
 	UPDATE qnaComment
 	SET content=#{content}
 	WHERE idx=#{idx}
 </update>

 </mapper>