<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="zaksim.dao.MypageDao">

	<resultMap type="zaksim.dto.ZakSimMember" id="ZakSimMember">
		<result property="memberType" column="member_type" />
		<result property="joinDate" column="join_date" />
		<result property="suspensionDate" column="suspension_date" />
	</resultMap>
	
  <resultMap type="zaksim.dto.PStatistics" id="PStatistics">
	<result property="failChal" column="fail_chal"/>
	<result property="successChal" column="success_chal"/>
	<result property="ingChal" column="ing_chal"/>
  </resultMap>

  <resultMap type="zaksim.dto.QnA" id="QnA">
	<result property="writerIdx" column="writer_idx"/>
	<result property="writtenDate" column="written_date"/>
	<result property="upperIdx" column="upper_idx"/>
  </resultMap>
  
   <resultMap type="zaksim.dto.Challenge" id="Challenge">
	<result column="idx" property="idx"/>
	<result column="member_idx" property="memberIdx"/>
	<result column="apply_date" property="applyDate"/>
	<result column="start_date" property="startDate"/>
	<result column="end_date" property="endDate"/>
	<result column="money" property="money"/>
	<result column="title" property="title"/>
	<result column="status" property="status"/>
	<result column="result" property="result"/>
  </resultMap> 
  
  <resultMap type="zaksim.dto.CommunityGroup" id="CommunityGroup">
	<result column="idx" property="idx" />
	<result column="member_idx" property="member_idx" />
	<result column="category_idx" property="category_idx" />
	<result column="title" property="title" />
	<result column="content" property="content" />
	<result column="image" property="image" />
	<result column="storedName" property="storedName" />
	<result column="max" property="max" />
	<result column="open_date" property="open_date" />
	<result column="secret" property="secret" />
	<result column="password" property="password" />
</resultMap>

	<resultMap type="zaksim.dto.Board" id="Board">
		<result column="idx" property="idx" />
		<result column="challenge_idx" property="challenge_idx" />
		<result column="group_idx" property="group_idx" />
		<result column="writer_idx" property="writer_idx" />
		<result column="title" property="title" />
		<result column="content" property="content" />
		<result column="image" property="image" />
		<result column="storedName" property="storedName" />
		<result column="open" property="open" />
		<result column="certification" property="certification" />
		<result column="written_date" property="written_date" />
		<result column="hit" property="hit" />
		<result column="COMMENTNUM" property="commentNum" />
		<result column="likenum" property="likeNum" />
		<collection property="communityGroup" resultMap="CommunityGroup" />
		<collection property="zakSimMember" resultMap="ZakSimMember" />
	</resultMap>
    
    
    
    
    
  
	<select id="memberInfo" parameterType="int" resultMap="ZakSimMember">
		SELECT * FROM ZaksimMember
		WHERE idx = #{idx}
	</select>

	<update id="updateMember" parameterType="map">
		UPDATE ZaksimMember
		SET
		<if test=" password != null and !password.equals('') ">
			password = #{password},
		</if>
		<if test=" email != null and !email.equals('')">
			email = #{email},
		</if>
		nick = #{nick},
		phone = #{phone}
		WHERE idx = #{idx}
	</update>

	<delete id="deleteMember" parameterType="int">
		DELETE FROM ZaksimMember
		WHERE idx = #{idx}
	</delete>
	
	<select id="selectChalData" parameterType="int" resultMap="PStatistics">
		SELECT c1.success_chal, c2.fail_chal, c3.ing_chal
		FROM (
			SELECT count(*) success_chal
			FROM challenge
			WHERE member_idx=#{idx} AND result = 'success'
		) c1
		LEFT JOIN (
			SELECT count(*) fail_chal
			FROM challenge
			WHERE member_idx=#{idx} AND result = 'fail'
		) c2
		ON 1=1
		LEFT JOIN (
			SELECT count(*) ing_chal
			FROM challenge
			WHERE member_idx=#{idx} AND status = 'ing'
		) c3
		ON 1=1
	</select>
	
	<select id="selectQnaList" parameterType="int" resultMap="QnA">
		SELECT Q2.IDX, Q2.TITLE, Q2.WRITTEN_DATE, Q2.STATUS
		FROM (
			SELECT ROWNUM RNUM, Q.* 
			FROM (
				SELECT * 
				FROM QNA 
				WHERE WRITER_IDX=#{idx} 
				ORDER BY WRITTEN_DATE DESC, IDX DESC
			) Q 
		) Q2
		WHERE RNUM <![CDATA[ < ]]>= 5
	</select>
	
	<select id="selectBoard" parameterType="int" resultType="zaksim.dto.Board">
		SELECT B2.*
		FROM (
			SELECT rownum rnum, B1.*
			FROM (
				SELECT *
				FROM board
				WHERE writer_idx=#{idx}
				ORDER BY written_date DESC, idx ASC
			) B1 
		) B2
		WHERE rnum <![CDATA[ < ]]>= 4
	</select>
	
	<select id="selectCommunityGroup" parameterType="int" resultType="zaksim.dto.CommunityGroup">
		SELECT C2.*
		FROM (
			SELECT rownum rnum, c1.*
			FROM (
				SELECT *
				FROM CommunityGroup
				WHERE member_idx=#{idx}
				ORDER BY open_date DESC, idx ASC
			) C1 
		) C2
		WHERE rnum <![CDATA[ < ]]>= 4
	</select>
	
	<select id="selectChallenge" parameterType="int" resultMap="Challenge">
		SELECT *
		FROM challenge
		WHERE member_idx=#{idx}
		AND status='ing'
	</select>
	
	<select id="selectCountIngChal" parameterType="int" resultType="int">
		SELECT COUNT(*) FROM challenge WHERE member_idx=#{idx} AND status='ing'
	</select>
	
	<select id="selectChallengeRate" parameterType="int" resultMap="Challenge">
		SELECT * 
		FROM (
			SELECT end_date - start_date + 1 dateNum 
			FROM challenge 
			WHERE idx=#{challengeIdx}
		) C
		left join (
			SELECT count(*) boardNum 
			FROM board 
			WHERE challenge_idx=#{challengeIdx} AND certification=1
		) B
		on 1=1
	</select>
	
	<select id="selectPw" parameterType="zaksim.dto.ZakSimMember" resultType="int">
		SELECT COUNT(*)
		FROM zakSimMember
		WHERE idx=#{idx}
		AND password=#{password}
	</select>
	
	<select id="selectEndChal" parameterType="int" resultMap="Challenge">
		SELECT rownum rnum, C.*
		FROM (
			SELECT *
			FROM challenge
			WHERE member_idx=#{idx}
			AND (status='halt' OR status='done')
		) C
	</select>
	
	<select id="selectCommunityGroupMember" parameterType="int" resultMap="CommunityGroup">
		SELECT idx
		FROM CommunityGroup
		WHERE member_idx = #{idx}
	</select>
	
	<update id="updateGroupMember" parameterType="zaksim.dto.CommunityGroup">
		UPDATE CommunityGroup
		SET member_idx = (
			SELECT g1.member_idx 
			FROM (
				SELECT rownum rnum, g.* 
				FROM (
					SELECT * 
					FROM groupmember 
					WHERE group_idx=#{idx} 
					ORDER BY idx asc
				) g
			) g1
			WHERE rnum=1
		)
		WHERE idx=#{idx}
	</update>
	
	<select id="checkAnotherMember" parameterType="zaksim.dto.CommunityGroup" resultType="int">
		SELECT COUNT(*)
		FROM groupMember
		WHERE group_idx=#{idx}
	</select>
	
	<delete id="deleteCommunityGroup" parameterType="zaksim.dto.CommunityGroup">
		DELETE communityGroup
		WHERE idx=#{idx}
	</delete>

	<select id="selectMyBoard" parameterType="int" resultMap="Board">
		SELECT * FROM board WHERE writer_idx=#{idx} AND certification=1 ORDER BY idx DESC
	</select>

	<select id="selectEndChallengeInfo" parameterType="int" resultMap="Challenge">
		SELECT * FROM challenge WHERE idx=#{endChalIdx}
	</select>

	<select id="selectEndChalBoard" parameterType="int" resultMap="Board">
		SELECT * FROM board WHERE challenge_idx=#{endChalIdx} ORDER BY idx DESC
	</select>

</mapper>